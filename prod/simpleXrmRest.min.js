var simpleXrmRest={fakeIt:function(){window.JSON||(console.log("It is not 1991 anymore. Please retire your Apple II or CalecoVision and use a browser that supports JSON."),window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(n){var t,i,r;if(n instanceof Object){if(t="",n.constructor===Array){for(i=0;i<n.length;t+=this.stringify(n[i])+",",i++);return"["+t.substr(0,t.length-1)+"]"}if(n.toString!==Object.prototype.toString)return'"'+n.toString().replace(/"/g,"\\$&")+'"';for(r in n)t+='"'+r.replace(/"/g,"\\$&")+'":'+this.stringify(n[r])+",";return"{"+t.substr(0,t.length-1)+"}"}return typeof n=="string"?'"'+n.replace(/"/g,"\\$&")+'"':String(n)}});simpleXrm.timedFormWarning("It is not 1991 anymore. Please retire your Apple II or CalecoVision and use a browser that supports JSON.",3e3,"ShameOnYou")},parseDate:function(n,t){var i;return typeof t=="string"&&(i=/Date\(([-+]?\d+)\)/.exec(t),i)?new Date(parseInt(t.replace("/Date(","").replace(")/",""),10)):t},XHR:function(n){var i,t;if(window.JSON||simpleXrmRest.fakeIt(),i=Xrm.Page.context.getClientUrl(),t={},simpleXrm.valid(i)){if(i+="/XRMServices/2011/OrganizationData.svc/"+n.query.toString(),window.XMLHttpRequest)t=new XMLHttpRequest;else if(window.ActiveXObject)t=new ActiveXObject("Microsoft.XMLHTTP");else return simpleXrm.error("We encountered an unexpected issue. Please check your form data before proceeding. Info for Admin: User's browser may not support one of the requested scripts. Please attempt using FireFox or IE 8+"),null;var r=n.type||"GET",r=r.toUpperCase(),u=null;r==="POST"&&n.data&&(u=window.JSON.stringify(n.data));t.open(r,encodeURI(i),!0);t.setRequestHeader("Accept","application/json");t.setRequestHeader("Content-Type","application/json; charset=utf-8");r==="POST"&&n.method&&t.setRequestHeader("X-HTTP-Method",n.method.toUpperCase());t.onreadystatechange=n.callback;u?t.send(u):t.send()}},associate:function(n){var t=Xrm.Page.context.getClientUrl(),i;simpleXrm.valid(t)&&(t+="/XRMServices/2011/OrganizationData.svc/",i={uri:t+n.parentEntity+"Set(guid'"+n.parentId+"')"},simpleXrmRest.XHR({query:n.childEntity+"Set(guid'"+n.childId+"')/$links/"+n.childForeignKey,callback:function(){this.readyState===4&&(this.onreadystatechange=null,(this.status===204||this.status===1223)&&n.callback())}}))},disassociate:function(n){var t=n.parentEntity+"Set(guid'"+n.parentId+"')/$links/"+n.childForeignKey+"(guid'"+childId+"')";simpleXrmRest.XHR({query:t,type:"POST",method:"DELETE",callback:function(){this.readyState===4&&(this.onreadystatechange=null,(this.status===204||this.status===1223)&&n.callback())}})},disassociateAll:function(n){var t=n.parentEntity+"Set?$select="+n.childForeignKey+"/"+n.childPrimaryKey+"&$expand="+n.childForeignKey+"&$filter="+n.parentPrimaryKey+" eq guid'"+n.parentId+"'";simpleXrmRest.XHR({query:t,callback:function(){var t,i;if(simpleXrmRest.parseOnReady(this)&&(t=simpleXrmRest.getRetrieveMultipleResults(this),t&&t.length>0)){for(i=0;i<t.length;i++)simpleXrmRest.disassociate({parentEntity:n.parentEntity,parentId:n.parentId,childForeignKey:n.childForeignKey,childId:t[i][n.childPrimaryKey]});n.callback()}}})},query:function(n){simpleXrmRest.XHR({query:simpleXrmRest.buildQuery({entitySet:n.entity+"Set"||null,guid:n.guid||null,select:simpleXrmRest.select(n.select)||null,filter:simpleXrmRest.filter(n.filter)||null,orderBy:simpleXrmRest.orderBy(n.orderBy)||null,expand:simpleXrmRest.expand(n.expand)||null,skip:simpleXrmRest.skip(n.skip)||null,top:simpleXrmRest.top(n.top)||null}),type:n.type||null,method:n.method||null,data:n.data||null,callback:n.callback||null})},mapResults:function(n){var r=n.map,i=n.results;for(var t in r)!i[t]||(typeof i[t]=="object"?i[t].Value?simpleXrm.setAttVal(r[t],i[t].Value):!i[t].Id||!i[t].Name?simpleXrm.clearAttVal(r[t]):simpleXrm.setAttVal(r[t],simpleXrm.parseRESTLookup(i[t])):simpleXrm.setAttVal(r[t],i[t]))},buildQuery:function(n){var t="",s=n.entitySet||null,h=n.guid||null,i=n.select||null,r=n.filter||null,u=n.orderBy||null,f=n.expand||null,e=n.skip||null,o=n.top||null;return s&&(t+=s.toString()),h&&(t+="(guid'"+simpleXrm.cleanGuid(h)+"')"),(i||r||u||f||e||o)&&(t+="?"),i&&(t+=i.toString()),r&&(i&&(t+="&"),t+=r.toString()),u&&((i||r)&&(t+="&"),t+=u.toString()),f&&((i||r||u)&&(t+="&"),t+=f.toString()),e&&((i||r||u||f)&&(t+="&"),t+=e.toString()),o&&((i||r||u||f||e)&&(t+="&"),t+=o.toString()),t},post:function(n){simpleXrm.query({type:"POST",method:"MERGE",entity:n.entityType,guid:n.id,data:n.data,callback:n.callback})},postMultiple:function(n){for(var i,f,r={},t=n.targets,u=0,e=t.length;u<e;u++)r[t[u].id]=!1;for(i=0,f=t.length;i<f;i++)simpleXrmRest.post({entity:t[i].entityType,guid:t[i].id,data:n.data,callback:function(){var u,f;if(simpleXrmRest.parseOnReady(this)){u=!1;r[t[i].id]=!0;for(f in r)if(!r[f]){u=!0;break}u||n.callback}}})},buildFilter:function(n){if(arguments&&arguments.length>0&&arguments[0])return""+(n.operator==="startswith"||n.operator==="substringof"||n.operator==="endswith"?n.operator+"("+n.attribute+","+n.value+")":n.attribute+" "+n.operator+" "+n.value);return""},groupFiltersOr:function(){return arguments&&arguments.length>0&&arguments[0]?"("+arguments.join(" or ")+")":""},groupFiltersAnd:function(){return arguments&&arguments.length>0&&arguments[0]?"("+arguments.join(" and "):""},filter:function(){var t,n;if(arguments&&arguments.length>0&&arguments[0]){for(t=[],n=0;n<arguments.length;n++)typeof arguments[n]=="object"?t.push(simpleXrmRest.buildFilter(arguments[n])):typeof arguments[n]=="string"&&t.push(arguments[n]);return"$filter="+simpleXrm.link(t," and ")}return""},select:function(){return arguments&&arguments.length>0&&arguments[0]?"$select="+simpleXrm.link(arguments,","):""},selectFromExpanded:function(n){var i,t;if(arguments&&arguments.length>0&&arguments[0]){for(i=[],t=1;t<arguments.length;t++)i.push(n.toString()+"/"+arguments[t].toString());return simpleXrm.link(i,",")}return""},expand:function(){return arguments&&arguments.length>0&&arguments[0]?"$expand="+simpleXrm.link(arguments,","):""},orderBy:function(){return arguments&&arguments.length>0&&arguments[0]?"$orderby="+simpleXrm.link(arguments,","):""},skip:function(n){return arguments&&arguments.length>0&&arguments[0]?"$skip="+n.toString():""},top:function(n){return arguments&&arguments.length>0&&arguments[0]?"$top="+n.toString():""},queryLookup:function(n){var t="guid'"+simpleXrm.cleanGuid(simpleXrm.getLookupID(n.lookup.toString()))+"'",i=n.entityType+"Set",r=simpleXrmRest.buildFilter({attribute:n.entityType+"Id",operator:"eq",value:t}),u=simpleXrmRest.filter(r),f=simpleXrmRest.select(simpleXrm.link(n.attributes,","));return simpleXrmRest.buildQuery({entitySet:i,filter:u,select:f})},parseOnReady:function(n){if(n.readyState===4&&(n.status===200||n.status===201))return JSON.parse(n.responseText).d},normalizeResults:function(n){return simpleXrmRest.getRetrieveSingleResults(n)},getRetrieveSingleResults:function(n){var t=null,i=simpleXrmRest.parseOnReady(n),r,u,f;return simpleXrm.valid(i)&&(r=i.results,u=i.result,simpleXrm.valid(r)?(f=r[0],simpleXrm.valid(f)&&(t=f)):simpleXrm.valid(u)&&(t=u)),t},getRetrieveMultipleResults:function(n){var i=null,r=simpleXrmRest.parseOnReady(n),t;return simpleXrm.valid(r)&&(t=r.results,simpleXrm.valid(t)&&(i=t)),i},getCreateResults:function(n){var t=null,i=simpleXrmRest.parseOnReady(n);return simpleXrm.valid(i)&&(t=i),t},setPriceListPrice:function(n){var t={product:null||simpleXrm.getLookupID(n.productLookupField),pricelist:null||simpleXrm.getLookupID(n.priceListLookupField),unitPriceField:n.unitPriceField,listPriceField:n.listPriceField,unitField:n.unitField,callback:null||n.callback};simpleXrm.valid(t.product)&&simpleXrm.valid(t.pricelist)&&simpleXrmRest.XHR({query:simpleXrmRest.buildQuery({entitySet:"ProductSet",select:"$select=CurrentCost,ProductNumber,Price,StandardCost",filter:"$filter=ProductId eq guid'"+t.product+"'"}),callback:function(){var i=simpleXrmRest.normalizeResults(this);simpleXrm.valid(i)&&(t.currentCost=simpleXrm.parseValue(i.CurrentCost.Value),t.productNumber=i.ProductNumber,t.listPrice=simpleXrm.parseValue(i.Price.Value),t.standardCost=simpleXrm.parseValue(i.StandardCost.Value),t.listPriceField&&(simpleXrm.setAttVal(t.listPriceField,t.listPrice),simpleXrm.sendAttAlways(t.listPriceField)),simpleXrmRest.XHR({query:simpleXrmRest.buildQuery({entitySet:"ProductPriceLevelSet",select:"$select=Amount,Percentage,PricingMethodCode,UoMId,RoundingOptionCode,RoundingPolicyCode,RoundingOptionAmount",filter:"$filter=(PriceLevelId/Id eq guid'"+t.pricelist+"' and ProductId/Id eq guid'"+t.product+"')"}),callback:function(){var u=simpleXrmRest.normalizeResults(this),i,f,r,e;if(u){t.amount=simpleXrm.parseValue(u.Amount.Value);t.percentage=simpleXrm.parseValue(u.Percentage);t.pricingMethodCode=simpleXrm.parseValue(u.PricingMethodCode.Value);t.unit=simpleXrm.parseRESTLookup(u.UoMId);t.unitField&&(simpleXrm.setAttVal(t.unitField,t.unit),simpleXrm.sendAttAlways(t.unitField));t.roundingOptionCode=simpleXrm.parseValue(u.RoundingOptionCode.Value);t.roundingPolicyCode=simpleXrm.parseValue(u.RoundingPolicyCode.Value);t.roundingOptionAmount=simpleXrm.parseValue(u.RoundingOptionAmount);i=null;f=!0;t.roundingPolicyCode==1&&(f=!1);switch(t.pricingMethodCode){case 1:i=t.amount;f=!1;break;case 2:i=t.percentage*t.listPrice/100;break;case 3:i=(t.percentage+100)*t.currentCost/100;break;case 4:i=100*t.currentCost/(100-t.percentage);break;case 5:i=(t.percentage+100)*t.standardCost/100;break;case 6:i=100*t.standardCost/(100-t.percentage);break;default:i=t.listPrice}if(f!=!0&&simpleXrm.valid(i))simpleXrm.setAttVal(n.unitPriceField,i);else if(f===!0&&simpleXrm.valid(i)){r=null;e=null;switch(t.roundingPolicyCode){case 2:t.roundingOptionCode==1?(r=10*Math.floor(i/10)+t.roundingOptionAmount,i>r&&(r+=10)):t.roundingOptionCode==2&&(r=Math.ceil(i/t.roundingOptionAmount)*t.roundingOptionAmount);break;case 3:t.roundingOptionCode==1?(r=10*Math.floor(i/10)+t.roundingOptionAmount,i<r&&(r-=10)):t.roundingOptionCode==2&&(r=Math.floor(i/t.roundingOptionAmount)*t.roundingOptionAmount);break;case 4:t.roundingOptionCode==1?(r=10*Math.floor(i/10)+t.roundingOptionAmount,i>r?e=r+10:i<r&&(r-=10,e=r+10),Math.abs(i-r)>Math.abs(i-e)&&(r=e)):t.roundingOptionCode==2&&(r=Math.round(i/t.roundingOptionAmount)*t.roundingOptionAmount)}simpleXrm.valid(r)&&(i=r)}simpleXrm.setAttVal(t.unitPriceField,i);simpleXrm.sendAttAlways(t.unitPriceField);try{t.callback()}catch(o){simpleXrm.timedFormError("The callback function could not be invoked.",3e3)}}}}))}})}};